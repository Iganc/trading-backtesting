{% extends 'backtest_app/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ display_symbol }} Chart{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@5.0.9/dist/lightweight-charts.standalone.production.js"></script>
<style>
html, body { height:100%; margin:0; padding:0; overflow:hidden; }
.chart-fullscreen { width:100%; height:100vh; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; position: relative;}
.chart-layout { display:flex; flex:1; min-height:0; height:100%; }
.sidebar { display:flex; flex-direction:column; gap:10px; margin-right:10px; }
.main-chart { flex:1; display:flex; flex-direction:column; min-height:0; }
#chart-container { flex:1; position:relative; width:100%; min-height:400px; cursor:crosshair; }
.legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.8); padding:8px; border-radius:4px; font-size:12px; z-index:10; }
.timeframe-buttons { display:flex; gap:10px; margin-bottom:10px; }
.timeframe-btn { padding:8px 16px; background:#e0e0e0; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.timeframe-btn.active { background:#007bff; color:white; }
.drawing-tools { display:flex; flex-direction:column; gap:10px; }
.drawing-btn {
    width: 40px;
    height: 40px;
    padding: 0;
    background: #e0e0e0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.drawing-btn.active { background:#ff7043; color:white; }
#save-session-btn {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
}
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chart-fullscreen">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="timeframe-buttons" style="display: flex; gap: 10px;">
            <button class="timeframe-btn" data-tf="1m">1m</button>
            <button class="timeframe-btn" data-tf="5m">5m</button>
            <button class="timeframe-btn" data-tf="15m">15m</button>
            <button class="timeframe-btn active" data-tf="1h">1h</button>
            <button class="timeframe-btn" data-tf="4h">4h</button>
            <button class="timeframe-btn" data-tf="1d">1d</button>
        </div>
        <div id="bar-replay-controls" style="display: flex; gap: 10px;">
            <button id="bar-replay-prev">◀</button>
            <button id="bar-replay-next">▶</button>
            <button id="bar-replay-fast">+5</button>
            <button id="bar-replay-reset">Reset</button>
            <span id="bar-replay-status"></span>
        </div>
    </div>
    <div class="chart-layout" style="display:flex; flex-direction:row; height:100%;">
        <div class="drawing-tools" style="min-width:60px; align-items:center;">
            <button id="long-tool" class="drawing-btn" title="Long">
                <span class="material-icons">north_east</span>
            </button>
            <button id="short-tool" class="drawing-btn" title="Short">
                <span class="material-icons">south_east</span>
            </button>
            <button id="line-tool" class="drawing-btn" title="Line">
                <span class="material-icons">show_chart</span>
            </button>
            <button id="fib-tool" class="drawing-btn" title="Fib">
                <span class="material-icons">timeline</span>
            </button>
            <button id="rect-tool" class="drawing-btn" title="Rect">
                <span class="material-icons">crop_square</span>
            </button>
            <button id="clear-drawings" class="drawing-btn" title="Clear">
                <span class="material-icons">clear</span>
            </button>
            <button id="magnet-tool" class="drawing-btn" title="Magnes">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="7" y="2" width="10" height="20" rx="5" fill="#333"/>
                    <rect x="9" y="4" width="6" height="8" rx="3" fill="#ff7043"/>
                </svg>
            </button>
        </div>
        <div class="main-chart" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <div id="chart-container">
                <div id="legend" class="legend"></div>
            </div>
        </div>
    </div>
    <button id="save-session-btn">Zapisz sesję</button>
</div>
{% endblock %}

{% block scripts %}


<script>
    window.display_symbol = "{{ display_symbol }}";
    window.start_date = "{{ start_date }}";
    window.end_date = "{{ end_date }}";
    window.csrf_token = "{{ csrf_token }}";
    window.chartData = JSON.parse('{{ chart_data|escapejs }}');
    window.totalCandlesCount = {{ session_total_candles|default:0 }};
    window.replayIndex = {{ visible_candles|default:1 }};
    window.current_candle = {{ current_candle|default:"{}"|safe }};
    window.saveSessionUrl = "{% url 'save_session' %}";
</script>
<script type="module" src="{% static 'backtest_app/js/main.js' %}"></script>
{% endblock %}