{% extends 'backtest_app/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ display_symbol }} Chart{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@5.0.9/dist/lightweight-charts.standalone.production.js"></script>
<style>
html, body { height:100%; margin:0; padding:0; overflow:hidden; }
.chart-fullscreen { width:100%; height:100vh; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; }
.chart-layout { display:flex; flex:1; min-height:0; height:100%; }
.sidebar { display:flex; flex-direction:column; gap:10px; margin-right:10px; }
.main-chart { flex:1; display:flex; flex-direction:column; min-height:0; }
#chart-container { flex:1; position:relative; width:100%; min-height:400px; cursor:crosshair; }
.legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.8); padding:8px; border-radius:4px; font-size:12px; z-index:10; }
.timeframe-buttons { display:flex; gap:10px; margin-bottom:10px; }
.timeframe-btn { padding:8px 16px; background:#e0e0e0; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.timeframe-btn.active { background:#007bff; color:white; }
.drawing-tools { display:flex; flex-direction:column; gap:10px; }
.drawing-btn {
    width: 40px;
    height: 40px;
    padding: 0;
    background: #e0e0e0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.drawing-btn.active { background:#ff7043; color:white; }
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="chart-fullscreen">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="timeframe-buttons" style="display: flex; gap: 10px;">
            <button class="timeframe-btn" data-tf="1m">1m</button>
            <button class="timeframe-btn" data-tf="5m">5m</button>
            <button class="timeframe-btn" data-tf="15m">15m</button>
            <button class="timeframe-btn active" data-tf="1h">1h</button>
            <button class="timeframe-btn" data-tf="4h">4h</button>
            <button class="timeframe-btn" data-tf="1d">1d</button>
        </div>
        <div id="bar-replay-controls" style="display: flex; gap: 10px;">
            <button id="bar-replay-prev">◀</button>
            <button id="bar-replay-next">▶</button>
            <button id="bar-replay-fast">+5</button>
            <button id="bar-replay-reset">Reset</button>
            <span id="bar-replay-status"></span>
        </div>
    </div>
    <div class="chart-layout" style="display:flex; flex-direction:row; height:100%;">
        <div class="drawing-tools" style="min-width:60px; align-items:center;">
            <button id="long-tool" class="drawing-btn" title="Long">
                <span class="material-icons">north_east</span>
            </button>
            <button id="short-tool" class="drawing-btn" title="Short">
                <span class="material-icons">south_east</span>
            </button>
            <button id="line-tool" class="drawing-btn" title="Line">
                <span class="material-icons">show_chart</span>
            </button>
            <button id="fib-tool" class="drawing-btn" title="Fib">
                <span class="material-icons">timeline</span>
            </button>
            <button id="rect-tool" class="drawing-btn" title="Rect">
                <span class="material-icons">crop_square</span>
            </button>
            <button id="clear-drawings" class="drawing-btn" title="Clear">
                <span class="material-icons">clear</span>
            </button>
            <button id="magnet-tool" class="drawing-btn" title="Magnes">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="7" y="2" width="10" height="20" rx="5" fill="#333"/>
                    <rect x="9" y="4" width="6" height="8" rx="3" fill="#ff7043"/>
                </svg>
            </button>
        </div>
        <div class="main-chart" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <div id="chart-container">
                <div id="legend" class="legend"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}

<script src="{% static 'backtest_app/bar-replay.js' %}"></script>
<script>
console.log("Template loaded");

// Parse data from server
let chartData;
try {
    chartData = JSON.parse('{{ chart_data|escapejs }}');
    console.log("Chart data parsed:", Object.keys(chartData));
} catch(e) {
    console.error("JSON parse error:", e);
    chartData = {};
}

// DOM
const chartContainer = document.getElementById('chart-container');
const legendElement = document.getElementById('legend');
let currentTimeframe = '1h';

function prepareCandleData(data) {
    return data.map(d => ({
        time: Number(d.time),
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close
    }));
}

// Chart config
const chartOptions = {
    layout: { background:{color:'#fff'}, textColor:'#333' },
    grid: { vertLines:{color:'#f0f0f0'}, horzLines:{color:'#f0f0f0'} },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderColor:'#d1d4dc' },
    timeScale: { borderColor:'#d1d4dc', timeVisible:true, secondsVisible:false },
    handleScroll: { vertTouchDrag:false },
};


const chart = LightweightCharts.createChart(chartContainer, chartOptions);

// Dodanie świec
const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
    upColor: '#26a69a',
    downColor: '#ef5350',
    borderVisible: false,
    wickUpColor: '#26a69a',
    wickDownColor: '#ef5350'
});




function updateLegend(data) {
    if (!data) return;
    const dateStr = data.time ? new Date(data.time*1000).toLocaleString() : '';
    legendElement.innerHTML = `
        <div>O: <strong>${data.open.toFixed(2)}</strong></div>
        <div>H: <strong>${data.high.toFixed(2)}</strong></div>
        <div>L: <strong>${data.low.toFixed(2)}</strong></div>
        <div>C: <strong>${data.close.toFixed(2)}</strong></div>
        <div>${dateStr}</div>
    `;
}

function loadTimeframeData(tf) {
    const tfData = chartData[tf] || [];
    if (!tfData.length) { alert('Brak danych dla tego timeframe'); return; }
    candleSeries.setData(prepareCandleData(tfData));
    updateLegend(tfData[tfData.length-1]);
    window.candles = tfData;
    window.dispatchEvent(new Event('candlesUpdated'));
    document.querySelectorAll('.timeframe-btn').forEach(btn=>btn.classList.remove('active'));
    document.querySelector(`.timeframe-btn[data-tf="${tf}"]`)?.classList.add('active');
}

document.querySelectorAll('.timeframe-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{currentTimeframe=btn.dataset.tf; loadTimeframeData(currentTimeframe)});
});

function resizeChart() {
    chart.applyOptions({width:chartContainer.clientWidth,height:chartContainer.clientHeight});
}
window.addEventListener('resize', resizeChart);
window.addEventListener('load', ()=>{
    resizeChart();
    loadTimeframeData(currentTimeframe);
});
chart.subscribeCrosshairMove(param => {
    if (!param.seriesPrices) return;
    const data = param.seriesPrices.get(candleSeries);
    if (data) updateLegend(data);
});
window.chart = chart;
</script>
<script src="{% static 'backtest_app/chart-tools.js' %}"></script>
{% endblock %}