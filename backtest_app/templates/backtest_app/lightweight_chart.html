{% extends 'backtest_app/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ display_symbol }} Chart{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@5.0.9/dist/lightweight-charts.standalone.production.js"></script>
<style>
html, body { height:100%; margin:0; padding:0; overflow:hidden; }
.chart-fullscreen { width:100%; height:100vh; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; position: relative;}
.chart-layout { display:flex; flex:1; min-height:0; height:100%; }
.sidebar { display:flex; flex-direction:column; gap:10px; margin-right:10px; }
.main-chart { flex:1; display:flex; flex-direction:column; min-height:0; }
#chart-container { flex:1; position:relative; width:100%; min-height:400px; cursor:crosshair; }
.legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.8); padding:8px; border-radius:4px; font-size:12px; z-index:10; }
.timeframe-buttons { display:flex; gap:10px; margin-bottom:10px; }
.timeframe-btn { padding:8px 16px; background:#e0e0e0; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.timeframe-btn.active { background:#007bff; color:white; }
.drawing-tools { display:flex; flex-direction:column; gap:10px; align-items: center; justify-content: center; }
.drawing-btn {
    width: 40px;
    height: 40px;
    padding: 0;
    background: #e0e0e0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.drawing-btn.active { background:#ff7043; color:white; }
#save-session-btn {
    margin-top: 30px;
    width: 75%;
    align-self: center;
    background: #007bff;
    color: #fff;
    border-radius: 4px;
    border: none;
    padding: 10px 0;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
}
#save-session-btn:hover {
    background: #0056b3;
}
.md-btn {
    background: #e0e0e0;
    border: none;
    border-radius: 4px;
    padding: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}
.md-btn:hover {
    background: #bdbdbd;
}
.material-symbols-outlined {
    font-size: 24px;
    color: #333;
}
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

{% endblock %}

{% block content %}
<div class="chart-fullscreen">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div class="timeframe-buttons" style="display: flex; gap: 10px;">
            <button class="timeframe-btn" data-tf="1m">1m</button>
            <button class="timeframe-btn" data-tf="5m">5m</button>
            <button class="timeframe-btn" data-tf="15m">15m</button>
            <button class="timeframe-btn active" data-tf="1h">1h</button>
            <button class="timeframe-btn" data-tf="4h">4h</button>
            <button class="timeframe-btn" data-tf="1d">1d</button>
        </div>
        {% if session_id %}
        <div id="session-balance-display" style="
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;">
            <span class="material-symbols-outlined" style="vertical-align:middle; font-size:22px; color:#007bff;">account_balance_wallet</span>
            {{ session_balance|floatformat:"0" | intcomma }} 
        </div>
        {% endif %}
        <div id="bar-replay-controls" style="display: flex; gap: 10px; align-items: center;">
            <button id="bar-replay-prev" class="md-btn" title="Poprzedni">
                <span class="material-symbols-outlined">arrow_left</span>
            </button>
            <button id="bar-replay-next" class="md-btn" title="Następny">
                <span class="material-symbols-outlined">arrow_right</span>
            </button>
            <button id="bar-replay-fast" class="md-btn" title="Szybko +5">
                <span class="material-symbols-outlined">forward_5</span>
            </button>
            <button id="bar-replay-reset" class="md-btn" title="Reset">
                <span class="material-symbols-outlined">restart_alt</span>
            </button>
            <span id="bar-replay-status"></span>
        </div>
    </div>
    <div class="chart-layout" style="display:flex; flex-direction:row; height:100%;">
        <div class="drawing-tools" style="min-width:60px; align-items:center;">
            <button id="long-tool" class="drawing-btn" title="Long">
                <span class="material-icons">north_east</span>
            </button>
            <button id="short-tool" class="drawing-btn" title="Short">
                <span class="material-icons">south_east</span>
            </button>
            <button id="line-tool" class="drawing-btn" title="Line">
                <span class="material-icons">show_chart</span>
            </button>
            <button id="fib-tool" class="drawing-btn" title="Density Small">
                <span class="material-icons">density_small</span>
            </button>
            <button id="rect-tool" class="drawing-btn" title="Rect">
                <span class="material-icons">crop_square</span>
            </button>
            <button id="clear-drawings" class="drawing-btn" title="Clear">
                <span class="material-icons">clear</span>
            </button>
            <button id="magnet-tool" class="drawing-btn" title="Magnes">
                <span class="material-icons">filter_alt</span>
            </button>
            <button id="save-session-btn">
                <span class="material-icons">save</span>
            </button>
        </div>
        <div class="main-chart" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <div id="chart-container">
                <div id="legend" class="legend"></div>
            </div>
        </div>
    </div>
    <div id="position-details" style="
            position: absolute;
            top: 80px;
            right: 30px;
            background: #fff;
            border: 1px solid #ccc;
            padding: 12px;
            z-index: 1000;
            min-width: 180px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            font-size: 14px;
            display: none;
        ">
    </div>
    <div id="save-session-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:32px 24px; border-radius:8px; box-shadow:0 2px 16px rgba(0,0,0,0.18); min-width:320px; display:flex; flex-direction:column; gap:18px;">
            <h3 style="margin:0 0 10px 0;">Nowa sesja backtestu</h3>
            <label>
                Nazwa sesji:
                <input type="text" id="session-name" style="width:100%; padding:6px; margin-top:4px;" maxlength="64" />
            </label>
            <label>
                Balans początkowy:
                <input type="number" id="session-balance" style="width:100%; padding:6px; margin-top:4px;" value="100000" min="0" step="100" />
            </label>
            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button id="cancel-save-session" style="padding:8px 18px;">Anuluj</button>
                <button id="confirm-save-session" style="padding:8px 18px; background:#007bff; color:#fff; border:none; border-radius:4px;">Zapisz</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}


<script>
    window.display_symbol = "{{ display_symbol }}";
    window.start_date = "{{ start_date }}";
    window.end_date = "{{ end_date }}";
    window.csrf_token = "{{ csrf_token }}";
    window.chartData = JSON.parse('{{ chart_data|escapejs }}');
    window.totalCandlesCount = {{ session_total_candles|default:0 }};
    window.replayIndex = {{ visible_candles|default:1 }};
    window.current_candle = {{ current_candle|default:"{}"|safe }};
    window.saveSessionUrl = "{% url 'save_session' %}";
    window.session_id = "{{ session_id|default:'' }}"; 
    window.session_name = "{{ session_name|default:'' }}";
    window.session_balance = {{ session_balance|default:100000 }};
    window.chartData = JSON.parse('{{ chart_data|escapejs }}');
</script>
<script type="module" src="{% static 'backtest_app/js/main.js' %}"></script>
{% endblock %}