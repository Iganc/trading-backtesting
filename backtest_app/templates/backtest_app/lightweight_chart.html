{% extends 'backtest_app/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ display_symbol }} Chart{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/lightweight-charts@5.0.9/dist/lightweight-charts.standalone.production.js"></script>
<style>
html, body { height:100%; margin:0; padding:0; overflow:hidden; }
.chart-fullscreen { width:100%; height:100vh; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; }
.chart-page { display:flex; flex-direction:column; flex:1; min-height:0; height:100%; }
#chart-container { flex:1; position:relative; width:100%; min-height:400px; cursor:crosshair; }
.legend { position:absolute; top:10px; right:10px; background:rgba(255,255,255,0.8); padding:8px; border-radius:4px; font-size:12px; z-index:10; }
.info-overlay { position:absolute; top:0; right:0; background:rgba(255,255,255,0.85); padding:8px 15px; margin:10px; border-radius:5px; z-index:20; font-size:12px; box-shadow:0 2px 5px rgba(0,0,0,0.1); max-width:70%; }
.info-overlay p { margin:3px 0; display:inline-block; margin-right:15px; }
.timeframe-buttons { display:flex; gap:10px; margin-bottom:10px; }
.timeframe-btn { padding:8px 16px; background:#e0e0e0; border:none; border-radius:4px; cursor:pointer; font-weight:bold; }
.timeframe-btn.active { background:#007bff; color:white; }
.drawing-tools { display:flex; gap:10px; margin-bottom:10px; }
.drawing-btn { padding:8px 16px; background:#e0e0e0; border:none; border-radius:4px; cursor:pointer; }
.drawing-btn.active { background:#ff7043; color:white; }
</style>
{% endblock %}

{% block content %}
<div class="chart-fullscreen">
    <div id="info" class="info-overlay">
        <p><strong>Symbol:</strong> {{ display_symbol }}</p>
        <p><strong>Date Range:</strong> {{ start_date }} to {{ end_date }}</p>
    </div>
    {% if data_warning %}
    <div class="warning"><strong>Uwaga:</strong> {{ data_warning }}</div>
    {% endif %}
    <div class="timeframe-buttons">
        <button class="timeframe-btn" data-tf="1m">1m</button>
        <button class="timeframe-btn" data-tf="5m">5m</button>
        <button class="timeframe-btn" data-tf="15m">15m</button>
        <button class="timeframe-btn active" data-tf="1h">1h</button>
        <button class="timeframe-btn" data-tf="4h">4h</button>
        <button class="timeframe-btn" data-tf="1d">1d</button>
    </div>
    <div class="drawing-tools">
        <button id="long-tool" class="drawing-btn">Long Position</button>
        <button id="short-tool" class="drawing-btn">Short Position</button>
        <button id="line-tool" class="drawing-btn">Line Tool</button>
        <button id="fib-tool" class="drawing-btn">Fibbonaci</button>
        <button id="rect-tool" class="drawing-btn">Rectangle</button>
        <button id="clear-drawings" class="drawing-btn">Clear All</button>
    </div>
    <div id="bar-replay-controls" style="gap:10px; margin:10px 0;">
      <button id="bar-replay-prev">◀</button>
      <button id="bar-replay-next">▶</button>
      <button id="bar-replay-fast">+5</button>
      <button id="bar-replay-reset">Reset</button>
      <span id="bar-replay-status"></span>
    </div>
    <div class="chart-page">
        <div id="chart-container">
            <div id="legend" class="legend"></div>
        </div>
    </div>
    {% if debug %}
    <div style="margin-top:30px; padding:15px; background-color:#f5f5f5; border:1px solid #ddd;">
        <h3>Debug Info:</h3>
        <p>Display Symbol: {{ display_symbol }}</p>
        <p>Count: {{ count }}</p>
        <p>Chart Data Length (JSON): {{ chart_data|length }} bytes</p>
        <pre style="max-height:200px; overflow:auto; background:#eee; padding:10px;">{{ chart_data|slice:":500" }}...</pre>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
console.log("Template loaded");

// Parse data from server
let chartData;
try {
    chartData = JSON.parse('{{ chart_data|escapejs }}');
    console.log("Chart data parsed:", Object.keys(chartData));
} catch(e) {
    console.error("JSON parse error:", e);
    chartData = {};
}

// DOM
const chartContainer = document.getElementById('chart-container');
const legendElement = document.getElementById('legend');
let currentTimeframe = '1h';

function prepareCandleData(data) {
    return data.map(d => ({
        time: Number(d.time),
        open: d.open,
        high: d.high,
        low: d.low,
        close: d.close
    }));
}

// Chart config
const chartOptions = {
    layout: { background:{color:'#fff'}, textColor:'#333' },
    grid: { vertLines:{color:'#f0f0f0'}, horzLines:{color:'#f0f0f0'} },
    crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
    rightPriceScale: { borderColor:'#d1d4dc' },
    timeScale: { borderColor:'#d1d4dc', timeVisible:true, secondsVisible:false },
    handleScroll: { vertTouchDrag:false },
};


const chart = LightweightCharts.createChart(chartContainer, chartOptions);

// Dodanie świec
const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
    upColor: '#26a69a',
    downColor: '#ef5350',
    borderVisible: false,
    wickUpColor: '#26a69a',
    wickDownColor: '#ef5350'
});




function updateLegend(data) {
    if (!data) return;
    const dateStr = data.time ? new Date(data.time*1000).toLocaleString() : '';
    legendElement.innerHTML = `
        <div>O: <strong>${data.open.toFixed(2)}</strong></div>
        <div>H: <strong>${data.high.toFixed(2)}</strong></div>
        <div>L: <strong>${data.low.toFixed(2)}</strong></div>
        <div>C: <strong>${data.close.toFixed(2)}</strong></div>
        <div>${dateStr}</div>
    `;
}

function loadTimeframeData(tf) {
    const tfData = chartData[tf] || [];
    if (!tfData.length) { alert('Brak danych dla tego timeframe'); return; }
    candleSeries.setData(prepareCandleData(tfData));
    updateLegend(tfData[tfData.length-1]);
    window.candles = tfData;
    window.dispatchEvent(new Event('candlesUpdated'));
    document.querySelectorAll('.timeframe-btn').forEach(btn=>btn.classList.remove('active'));
    document.querySelector(`.timeframe-btn[data-tf="${tf}"]`)?.classList.add('active');
}

document.querySelectorAll('.timeframe-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{currentTimeframe=btn.dataset.tf; loadTimeframeData(currentTimeframe)});
});

function resizeChart() {
    chart.applyOptions({width:chartContainer.clientWidth,height:chartContainer.clientHeight});
}
window.addEventListener('resize', resizeChart);
window.addEventListener('load', ()=>{
    resizeChart();
    loadTimeframeData(currentTimeframe);
});
chart.subscribeCrosshairMove(param => {
    if (!param.seriesPrices) return;
    const data = param.seriesPrices.get(candleSeries);
    if (data) updateLegend(data);
});
window.chart = chart;

</script>
<script src="{% static 'backtest_app/chart-tools.js' %}"></script>
<script src="{% static 'backtest_app/bar-replay.js' %}"></script>
{% endblock %}
