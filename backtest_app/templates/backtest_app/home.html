{% extends 'backtest_app/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Continuous Contract Backtesting{% endblock %}

{% block content %}
    {% if user.is_authenticated %}
        <p>Witaj, {{ user.username }}! 
            <form action="{% url 'logout' %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn">Wyloguj się</button>
            </form>
        </p>
        <select id="session-select">
            <option value="">-- wybierz sesję --</option>
            {% for s in user_sessions %}
            <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
        </select>
        <button id="load-session-btn">Wczytaj sesję</button>

    {% else %}
        <p>
            <a class="btn" href="{% url 'login' %}">Zaloguj się</a>
            <a class="btn" href="{% url 'register' %}">Rejestracja</a>
        </p>
    {% endif %}
    <h1>Continuous Contract Backtesting</h1>
    
    {% for symbol, info in data.items %}
        <div class="card">
            <h2>{{ symbol }} Futures</h2>
            <div class="price">${{ info.latest_price|floatformat:2 }}</div>
            <p>Dane dostępne od: {{ info.earliest_date }} do {{ info.latest_date }}</p>
            <p>Liczba rekordów: {{ info.total_records | intcomma }}</p>
            
            <div class="links">
                <h3>Popularne zakresy dat:</h3>
                <a class="btn" href="/{{ symbol }}/{{ last_week }}/{{ today }}/">Ostatni tydzień</a>
                <a class="btn" href="/{{ symbol }}/{{ last_month }}/{{ today }}/">Ostatni miesiąc</a>
                <a class="btn" href="/{{ symbol }}/{{ last_year }}/{{ today }}/">Ostatni rok</a>
                <a class="btn" href="/{{ symbol }}/{{ info.earliest_date }}/{{ info.latest_date }}/">Wszystkie dane</a>
                <a class="btn" href="/{{ symbol }}/{{ info.earliest_date }}/">Od początku</a>
                <a class="btn" href="{% url 'symbol_date_range' symbol='ES' start_date=random_date_from end_date=random_date_to %}">
                    Losowy tydzień ({{random_date_from}} - {{random_date_to}})
                </a>
            </div>
            
            <div class="links">
                <h3>Formularz wyboru daty:</h3>
                <form action="javascript:void(0);" id="{{ symbol }}Form">
                    <input type="date" name="start_date" required min="{{ info.earliest_date }}" max="{{ info.latest_date }}">
                    <input type="date" name="end_date" min="{{ info.earliest_date }}" max="{{ info.latest_date }}">
                    <button type="button" onclick="submitForm('{{ symbol }}')">Wyszukaj</button>
                </form>
            </div>
        </div>
    {% endfor %}
{% endblock %}

{% block scripts %}
    <script>
        function submitForm(symbol) {
            const form = document.getElementById(symbol + 'Form');
            const startDate = form.elements['start_date'].value;
            const endDate = form.elements['end_date'].value;
            
            if (startDate && endDate) {
                window.location.href = `/${symbol}/${startDate}/${endDate}/`;
            } else if (startDate) {
                window.location.href = `/${symbol}/${startDate}/`;
            } else {
                alert('Podaj przynajmniej datę początkową');
            }
        }
        document.getElementById('load-session-btn').addEventListener('click', () => {
            const select = document.getElementById('session-select');
            const sessionId = select.value;
            if (!sessionId) return alert('Wybierz sesję');

            window.location.href = "{% url 'chart_from_session' 0 %}".replace('/0/', `/${sessionId}/`);
        });
    </script>
{% endblock %}